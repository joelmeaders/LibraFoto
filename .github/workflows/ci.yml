name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Version Validation
  # =============================================================================
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check version format
        run: |
          VERSION=$(cat .version)
          echo "Version: $VERSION"

          # Check if this is the main branch
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Branch: $BRANCH"

          # Stable version pattern: #.#.# (no prerelease suffix)
          STABLE_PATTERN="^[0-9]+\.[0-9]+\.[0-9]+$"

          # Prerelease pattern: #.#.#-alpha.#, #.#.#-beta.#, #.#.#-rc.#
          PRERELEASE_PATTERN="^[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta|rc)\.[0-9]+$"

          if [[ "$BRANCH" == "main" ]]; then
            # Main branch MUST use stable versions only
            if [[ ! "$VERSION" =~ $STABLE_PATTERN ]]; then
              echo "::error::Invalid version format for main branch: $VERSION"
              echo "::error::Main branch requires stable versions (#.#.#)"
              echo "::error::Prerelease versions are not allowed on main"
              exit 1
            fi
            echo "✅ Stable version '$VERSION' is valid for main branch"
          else
            # Feature branches MUST use prerelease versions
            if [[ "$VERSION" =~ $STABLE_PATTERN ]]; then
              echo "::error::Stable version '$VERSION' not allowed on branch '$BRANCH'"
              echo "::error::Feature branches must use prerelease versions like:"
              echo "::error::  - 1.0.0-alpha.1"
              echo "::error::  - 1.0.0-beta.2"
              echo "::error::  - 1.0.0-rc.1"
              echo ""
              echo "To fix: Update .version file to use a prerelease suffix"
              exit 1
            fi
            
            if [[ ! "$VERSION" =~ $PRERELEASE_PATTERN ]]; then
              echo "::error::Invalid prerelease version format: $VERSION"
              echo "::error::Expected format: #.#.#-(alpha|beta|rc).#"
              exit 1
            fi
            
            echo "✅ Prerelease version '$VERSION' is valid for feature branch '$BRANCH'"
          fi

  # =============================================================================
  # Backend Build & Test
  # =============================================================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore --solution LibraFoto.slnx

      - name: Check formatting
        run: dotnet format --solution LibraFoto.slnx --verify-no-changes --verbosity diagnostic

      - name: Build solution
        run: dotnet build --solution LibraFoto.slnx --no-restore --configuration Release

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: build-backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Run backend tests with coverage
        run: |
          dotnet test --solution LibraFoto.slnx --configuration Release \
            --logger "trx;LogFileName=test-results.trx" \
            --results-directory ./TestResults \
            --collect:"XPlat Code Coverage" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"./TestResults/**/coverage.cobertura.xml" \
            -targetdir:"./TestResults/CoverageReport" \
            -reporttypes:"Html;Cobertura;TextSummary"

      - name: Check backend coverage threshold
        run: |
          # Parse the summary and check each assembly's coverage
          SUMMARY_FILE="./TestResults/CoverageReport/Summary.txt"
          if [[ ! -f "$SUMMARY_FILE" ]]; then
            echo "::error::Coverage summary not found"
            exit 1
          fi

          cat "$SUMMARY_FILE"

          # Extract line coverage percentage
          LINE_COVERAGE=$(grep -oP 'Line coverage: \K[0-9.]+' "$SUMMARY_FILE" || echo "0")
          echo "Overall line coverage: ${LINE_COVERAGE}%"

          # Check if coverage meets threshold (80%)
          if (( $(echo "$LINE_COVERAGE < 80" | bc -l) )); then
            echo "::error::Backend coverage ${LINE_COVERAGE}% is below 80% threshold"
            exit 1
          fi

          echo "✅ Backend coverage ${LINE_COVERAGE}% meets 80% threshold"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: ./TestResults/*.trx

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: ./TestResults/CoverageReport/

  # =============================================================================
  # Admin Frontend Build & Test
  # =============================================================================
  build-admin:
    name: Build Admin Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontends/admin
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontends/admin/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: admin-dist
          path: frontends/admin/dist/

  test-admin:
    name: Test Admin Frontend
    runs-on: ubuntu-latest
    needs: build-admin
    defaults:
      run:
        working-directory: frontends/admin
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontends/admin/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage -- --coverage.thresholds.lines=80 --coverage.thresholds.functions=80 --coverage.thresholds.branches=80 --coverage.thresholds.statements=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: admin-coverage
          path: frontends/admin/coverage/

  # =============================================================================
  # Display Frontend Build & Test
  # =============================================================================
  build-display:
    name: Build Display Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontends/display
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontends/display/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: display-dist
          path: frontends/display/dist/

  test-display:
    name: Test Display Frontend
    runs-on: ubuntu-latest
    needs: build-display
    defaults:
      run:
        working-directory: frontends/display
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: frontends/display/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage -- --coverage.thresholds.lines=80 --coverage.thresholds.functions=80 --coverage.thresholds.branches=80 --coverage.thresholds.statements=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: display-coverage
          path: frontends/display/coverage/

  # =============================================================================
  # CI Summary
  # =============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - validate-version
      - build-backend
      - test-backend
      - build-admin
      - test-admin
      - build-display
      - test-display
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.validate-version.result }}" != "success" ]] || \
             [[ "${{ needs.build-backend.result }}" != "success" ]] || \
             [[ "${{ needs.test-backend.result }}" != "success" ]] || \
             [[ "${{ needs.build-admin.result }}" != "success" ]] || \
             [[ "${{ needs.test-admin.result }}" != "success" ]] || \
             [[ "${{ needs.build-display.result }}" != "success" ]] || \
             [[ "${{ needs.test-display.result }}" != "success" ]]; then
            echo "::error::One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"

      - name: Summary
        run: |
          echo "## CI Results :white_check_mark:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Validation | ${{ needs.validate-version.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Backend | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Backend (≥80% coverage) | ${{ needs.test-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Admin | ${{ needs.build-admin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Admin (≥80% coverage) | ${{ needs.test-admin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Display | ${{ needs.build-display.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Display (≥80% coverage) | ${{ needs.test-display.result }} |" >> $GITHUB_STEP_SUMMARY
