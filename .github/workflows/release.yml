name: Release

# Only create GitHub Releases for stable version tags
# Pre-release tags (v1.0.0-alpha.1) are handled by docker-build.yml only
on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on all version tags, filter pre-releases below

permissions:
  contents: write
  packages: read

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    # Skip if tag contains a hyphen (pre-release) - safety check
    if: ${{ !contains(github.ref_name, '-') }}
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: tag
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "Tag version: $TAG_VERSION"

      - name: Read version file
        id: version
        run: |
          FILE_VERSION=$(cat .version)
          echo "VERSION=${FILE_VERSION}" >> $GITHUB_OUTPUT
          echo "File version: $FILE_VERSION"

      - name: Validate version match
        run: |
          TAG_VERSION="${{ steps.tag.outputs.TAG_VERSION }}"
          FILE_VERSION="${{ steps.version.outputs.VERSION }}"

          if [[ "$TAG_VERSION" != "$FILE_VERSION" ]]; then
            echo "::error::Tag version ($TAG_VERSION) does not match .version file ($FILE_VERSION)"
            exit 1
          fi

          # Validate stable version format for releases
          STABLE_PATTERN="^[0-9]+\.[0-9]+\.[0-9]+$"
          if [[ ! "$FILE_VERSION" =~ $STABLE_PATTERN ]]; then
            echo "::error::Release tags must use stable versions (#.#.#), not prerelease versions"
            echo "::error::Found: $FILE_VERSION"
            exit 1
          fi

          echo "âœ… Version $FILE_VERSION validated for release"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [[ -n "$PREV_TAG" ]]; then
            echo "Changes since $PREV_TAG:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD >> CHANGELOG.md
          else
            echo "Initial release" >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Docker Images" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Pull the images from GitHub Container Registry:" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository }}-api:${{ needs.validate.outputs.version }}" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository }}-admin-ui:${{ needs.validate.outputs.version }}" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository }}-display-ui:${{ needs.validate.outputs.version }}" >> CHANGELOG.md
          echo "docker pull ghcr.io/${{ github.repository }}-proxy:${{ needs.validate.outputs.version }}" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Quick Install (Raspberry Pi)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "\`\`\`bash" >> CHANGELOG.md
          echo "curl -sSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash" >> CHANGELOG.md
          echo "\`\`\`" >> CHANGELOG.md

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp docker/docker-compose.yml release-assets/
          cp docker/docker-compose.ghcr.yml release-assets/
          cp install.sh release-assets/
          cp update.sh release-assets/

          # Create .env template
          cat > release-assets/.env.template << 'EOF'
          # LibraFoto Environment Configuration
          # Copy this file to .env and update the values

          # Host IP address (used for QR codes)
          LIBRAFOTO_HOST_IP=

          # JWT signing key (generate with: openssl rand -base64 32)
          JWT_KEY=change-this-secret-key-in-production-minimum-32-characters

          # Application version
          VERSION=${{ needs.validate.outputs.version }}

          # Deploy mode: 'build' (local source build) or 'ghcr' (pre-built GitHub images)
          DEPLOY_MODE=ghcr

          # GHCR image tag (used when DEPLOY_MODE=ghcr)
          LIBRAFOTO_IMAGE_TAG=latest

          # Optional: Google Photos Integration
          # GooglePhotos__ClientId=
          # GooglePhotos__ClientSecret=
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: LibraFoto v${{ needs.validate.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            release-assets/docker-compose.yml
            release-assets/docker-compose.ghcr.yml
            release-assets/install.sh
            release-assets/update.sh
            release-assets/.env.template
          generate_release_notes: false
